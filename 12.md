NUT-12: Offline mint signature validation
==========================

`optional` `author: calle`

---

In this document, we present an extension of Cashu's crypto system to allow a user Alice to verify the mint Bob's signature using only Bob's public keys. We explain how another user Carol who receives ecash from Alice can execute the DLEQ proof as well. This is achieved using a Discrete Log Equality (DLEQ) proof. Previously, Bob's signature could only be checked by himself using his own private keys ([NUT-00](00)). 

# The DLEQ proof
The purpose of this DLEQ is to prove that the mint has used the same private key `a` for creating its public key `A` ([NUT-01](01)) and for signing the BlindedMessage `B'`. Bob returns the proof with the blind signature `C'` during a mint or split operation. 

The complete DLEQ proof reads
```
# DLEQ Proof

(These steps occur once Bob returns C')

Bob:
r = random nonce
R1 = r*G
R2 = r*B'
e = hash(R1,R2,A,C')
s = r + e*a
return e, s

Alice:
R1 = s*G - e*A
R2 = s*B' - e*C'
e == hash(R1,R2,A,C')

If true, a in A = a*G must be equal to a in C' = a*B'
```

### DLEQ in `BlindedSignature`

The mint produces these DLEQ proofs when returning `BlindedSignature`'s upon the `POST /mint` and `POST /split` responses. The `BlindedSignature` object is extended in the following way to include the DLEQ proof:

```python
{
  "id": <str>,
  "amount": <int>,
  "C_": <str>,
  "dleq": {  # New: DLEQ proof
    "e": <str>,
    "s": <str>
  }
}

```

`e` and `s` are the challenge and response of the DLEQ proof. 

### DLEQ in `Proof`

In order for Alice to communicate the DLEQ to another user Carol, we extend the `Proof` (see [NUT-00](00)) object and include the DLEQ proof. As explained below, we also need to include the blinding factor `r` for the proof to be convincing to another user Carol.

```
{
  "id": <str>,
  "amount": <int>,
  "secret": <str>,
  "C": <str>,
  "dleq": {# New: DLEQ proof
    "e": <str>,
    "s": <str>,
    "r": <str>
  }
}
```
`e` and `s` are the challenge and response of the DLEQ proof returned by Bob, `r` is the blinding factor of Alice that was used to generate the `Proof`.

## Alice (minting user)

Alice is the user interacting with the mint Bob. As described above, Alice receives the DLEQ proof in the `BlindedSignature` response from the mint upon calling `POST /mint` or `POST /split`. Alice checks its validity via the equations:

```
R1 = s*G - e*A
R2 = s*B' - e*C'
e == hash(R1,R2,A,C') # must be True
```

Here, the variables are
- `A` – the public key Bob used to sign this Proof
- `(e, s)` – the DLEQ proof returned by Bob
- `B'` – Alice's `BlindedMessage`
- `C'` – Bob's `BlindedSignature` on `B'`

As we can see, in order to execute the proof, Alice needs `e, s` that are returned in the `BlindedSignature` by Bob. Alice further needs `B'` (the `BlindedMessage` that Bob signed) and `C'` , the blind signature in the `BlindedSignature` response from Bob, and `A`, the public key of Bob with which he signed the BlindedMessage. All these values are available during or after the `/mint` and `/split` operations.

**Note:** If a DLEQ proof is included in the mint's `BlindedSignature` response, wallet **MUST** verify the DLEQ proof. 

## Carol (third-party user)

Carol is a user that validates a `Proof` from another user Alice. When Alice sends a token that includes `Proofs` with DLEQ proofs to Carol or when Alice posts a `Proof` publicly, Carol can execute the DLEQ proof herself to validate Bob's signature without having to talk to Bob. Alice must include the following information in the `Proof`:

- `(x, C)` – the ecash `Proof`
- `(e, s)` – the DLEQ proof revealed by Alice
- `r` – Alice's blinding factor

Here, `x` is the Proof's secret, and `C` is the mint's signature on it. To execute the DLEQ proof like Alice did above, Carol needs `(B', C')` which she can compute herself using the blinding factor `r` that she receives from Alice.

To verify the DLEQ proof of a received token, Carol needs to reconstruct `B'` and `C'` using the blinding factor `r` that Alice has included in the `Proof` she sent to Carol:

```
Y = hash_to_curve(x)
C' = C + r*A
B' = Y + r*G
... (same as Alice)
```

Now that Carol has all the necessary variables, she can execute the same equations as Alice did.

**Note:** If a DLEQ proof is included in a received token, wallet **MUST** verify the proof. 
